name: Terraform Bootstrap (manual)

# Run only when triggered manually from the GitHub Actions
on:
  workflow_dispatch:
    inputs:
      tfstate_bucket:                 # Workflow input: S3 bucket name to create
        description: 'S3 bucket name for terraform state'
        required: true
        default: 'my-tfstate-bucket'
      tfstate_lock_table:             # Workflow input: DynamoDB table name to create
        description: 'DynamoDB table name for terraform locking'
        required: true
        default: 'my-tf-lock-table'
      aws_region:
        description: 'AWS region to create resources in'
        required: false
        default: 'us-east-1'

# Minimal permissions the workflow needs from GitHub for OIDC usage and repo read
permissions:
  id-token: write   # required to request an OIDC token for AWS
  contents: read    # allow checking out repo files

jobs:
  bootstrap:
    name: Bootstrap backend (manual)
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repository so the workflow can access terraform/bootstrap files
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Configure AWS credentials using OIDC (assume role)
      #    Replace the role-to-assume line with your actual role ARN once you've created the IAM role.
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ inputs.role_to_assume || 'arn:aws:iam::<AWS_ACCOUNT_ID>:role/GitHubActionsBootstrapRole' }}
          aws-region: ${{ github.event.inputs.aws_region || 'us-east-1' }}

      # 3) Install Terraform CLI so we can run terraform commands
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'

      # 4) Initialize terraform in the bootstrap directory (local state)
      - name: Terraform init (bootstrap)
        working-directory: terraform/bootstrap
        run: terraform init -input=false

      # 5) Check formatting â€” quick lint; will fail if formatting is wrong
      - name: Terraform fmt
        working-directory: terraform/bootstrap
        run: terraform fmt -check || { echo "Run terraform fmt locally to fix formatting"; exit 0; }

      # 6) Validate the configuration syntax
      - name: Terraform validate
        working-directory: terraform/bootstrap
        run: terraform validate

      # 7) Apply the bootstrap (creates S3 bucket and DynamoDB table)
      #    We pass the bucket and table names as environment variables (from workflow inputs).
      - name: Terraform apply (bootstrap)
        working-directory: terraform/bootstrap
        env:
          TF_VAR_tfstate_bucket: ${{ github.event.inputs.tfstate_bucket }}
          TF_VAR_tfstate_lock_table: ${{ github.event.inputs.tfstate_lock_table }}
          AWS_REGION: ${{ github.event.inputs.aws_region }}
        run: terraform apply -auto-approve -input=false
